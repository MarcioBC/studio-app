<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title> 
    <link rel="stylesheet" href="/css/global.css">
    <link rel="stylesheet" href="/css/clientes.css">
    <link rel="stylesheet" href="/css/agendamentos.css">
    <link rel="stylesheet" href="/css/dashboard.css">
</head>
<body>
    <button class="menu-toggle" id="menuToggle">☰</button>
    <div class="dashboard-container">
        <aside class="sidebar" id="sidebar">
            <h2 id="sidebarCompanyName"></h2> 
            <nav>
                <ul>
                    <li><a href="/dashboard.html" class="active">Dashboard</a></li>
                    <li><a href="/clientes.html">Clientes</a></li>
                    <li><a href="/agendamentos.html">Agendamentos</a></li>
                    <li><a href="/livro-caixa.html">Livro Caixa</a></li>
                    <li><a href="/relatorios.html">Relatórios</a></li>
                    <li><a href="/profissionais.html">Gerenciar profissionais</a></li> 
                    <li><a href="/gerenciar-usuarios.html">Gerenciar Usuários</a></li>
                    <li style="margin-top: auto;"><a href="/api/auth/logout" style="color: #ffc107;">Sair</a></li> 
    </ul>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <h1>Dashboard - <span id="dashboardHeaderCompanyName"></span></h1> 
            </header>

            <section class="dashboard-cards">
                <div class="dashboard-card card-hoje">
                    <h3>Agendamentos de Hoje</h3>
                    <p class="count" id="totalHoje">0</p>
                </div>
                <div class="dashboard-card card-semana">
                    <h3>Na Semana</h3>
                    <p class="count" id="totalSemana">0</p>
                </div>
                <div class="dashboard-card card-confirmados">
                    <h3>Confirmados</h3>
                    <p class="count" id="totalConfirmados">0</p>
                </div>
                <div class="dashboard-card card-concluidos">
                    <h3>Concluídos</h3>
                    <p class="count" id="totalConcluidos">0</p>
                </div>
            </section>

            <section class="client-list-container">
                <h2>Agenda do Dia</h2>
                <div id="hojeList">
                    <p>Carregando agendamentos de hoje...</p>
                </div>
            </section>
        </main>
    </div>

    <script src="/js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Lógica para carregar o nome da empresa (CORRIGIDO) ---
            const companyName = localStorage.getItem('companyName');
            console.log("Dashboard: companyName lido do localStorage:", companyName); // DEBUG

            // Elementos HTML para atualizar
            // Removido 'pageTitleSpan' pois document.title é atualizado diretamente
            const sidebarCompanyNameElement = document.getElementById('sidebarCompanyName');
            const dashboardHeaderCompanyNameElement = document.getElementById('dashboardHeaderCompanyName');

            // DEBUG: Verificando se os elementos foram encontrados
            console.log("Dashboard: Elemento sidebarCompanyNameElement encontrado?", !!sidebarCompanyNameElement);
            console.log("Dashboard: Elemento dashboardHeaderCompanyNameElement encontrado?", !!dashboardHeaderCompanyNameElement);


            if (companyName) {
                console.log("Dashboard: companyName encontrado no localStorage. Atualizando elementos UI."); // DEBUG
                // ATUALIZA O TÍTULO DA ABA DO NAVEGADOR DIRETAMENTE
                document.title = `${companyName} - Dashboard`; 
                
                // Atualiza o nome na barra lateral
                if (sidebarCompanyNameElement) {
                    sidebarCompanyNameElement.textContent = companyName;
                }
                // Atualiza o nome no cabeçalho do dashboard
                if (dashboardHeaderCompanyNameElement) {
                    dashboardHeaderCompanyNameElement.textContent = companyName;
                }
            } else {
                console.warn("Dashboard: companyName NÃO encontrado no localStorage. O nome padrão 'Studio Je Marqui' será usado."); // DEBUG
                // Se o nome não for encontrado, defina um nome padrão para a UI
                document.title = "Studio Je Marqui - Dashboard"; // Define título padrão
                if (sidebarCompanyNameElement) {
                    sidebarCompanyNameElement.textContent = "Studio Je Marqui";
                }
                if (dashboardHeaderCompanyNameElement) {
                    dashboardHeaderCompanyNameElement.textContent = "Studio Je Marqui";
                }
                // Opcional: Redirecionar para o login se o nome da empresa não for encontrado (sessão expirada, etc.)
                // window.location.href = '/index.html'; 
            }
            // --- FIM DA LÓGICA DE CARREGAMENTO DE NOME ---


            const formatAsCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);

            async function fetchDashboardSummary() {
                try {
                    const response = await fetch('/api/agendamentos/summary/dashboard');
                    const summary = await response.json();
                    document.getElementById('totalHoje').textContent = summary.hoje || 0;
                    document.getElementById('totalSemana').textContent = summary.semana || 0;
                    document.getElementById('totalConfirmados').textContent = summary.confirmados || 0;
                    document.getElementById('totalConcluidos').textContent = summary.concluidos || 0;
                } catch (error) {
                    console.error("Erro ao buscar resumo do dashboard:", error);
                }
            }

            async function fetchHojeAgendamentos() {
                const hojeListDiv = document.getElementById('hojeList');
                hojeListDiv.innerHTML = '<p>Carregando agendamentos de hoje...</p>';
                try {
                    const response = await fetch('/api/agendamentos/hoje');
                    const agendamentos = await response.json();
                    hojeListDiv.innerHTML = '';
                    if (agendamentos.length === 0) {
                        hojeListDiv.innerHTML = '<p>Nenhum agendamento para hoje.</p>';
                        return;
                    }
                    agendamentos.forEach(ag => {
                        const card = document.createElement('div');
                        card.className = 'client-card';
                        const horaFormatada = new Date(ag.dataAgendamento).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                        const nomesProcedimentos = ag.procedimentos.map(p => p.nome).join(', ');
                        const statusClass = `status-${(ag.status || 'pendente').toLowerCase().replace('ú', 'u')}`;
                        card.innerHTML = `
                            <div style="flex: 1;">
                                <strong>${horaFormatada} - ${ag.cliente ? ag.cliente.nome : 'Cliente Removido'}</strong><br>
                                <small><b>Procedimentos:</b> ${nomesProcedimentos}</small><br>
                                <small><b>Profissional:</b> ${ag.profissional} - <b>Sala:</b> ${ag.sala}</small>
                            </div>
                            <div style="text-align: right;">
                                <span class="status ${statusClass}">${ag.status}</span>
                                <p style="margin:10px 0 0 0; font-weight: bold;">${formatAsCurrency(ag.valorTotal)}</p>
                            </div>
                        `;
                        hojeListDiv.appendChild(card);
                    });
                } catch (error) {
                    console.error("Erro ao buscar agendamentos de hoje:", error);
                    hojeListDiv.innerHTML = '<p style="color:red;">Erro ao carregar a agenda do dia.</p>';
                }
            }

            fetchDashboardSummary();
            fetchHojeAgendamentos();

            // --- INÍCIO DA LÓGICA DE INATIVIDADE ---
        const INACTIVITY_TIME = 10 * 60 * 1000; // 10 minutos em milissegundos
        // Se você quer 10 segundos para teste: const INACTIVITY_TIME = 10 * 1000; // 10 segundos
        let timeoutId;

        function startInactivityTimer() {
            // Limpa qualquer temporizador anterior
            clearTimeout(timeoutId);
            // Define um novo temporizador
            timeoutId = setTimeout(logoutUser, INACTIVITY_TIME);
        }

        function resetInactivityTimer() {
            // Chama startInactivityTimer apenas se o usuário estiver logado
            if (localStorage.getItem('token')) { // Verifica se há um token (indicando que está logado)
                startInactivityTimer();
            }
        }

        // Inicia o temporizador quando a página carrega
        resetInactivityTimer();

        // Monitora eventos de atividade do usuário
        document.addEventListener('mousemove', resetInactivityTimer);
        document.addEventListener('keypress', resetInactivityTimer);
        document.addEventListener('click', resetInactivityTimer);
        document.addEventListener('scroll', resetInactivityTimer);
        // --- FIM DA LÓGICA DE INATIVIDADE ---
    });
        
         </script>
</body>
</html>