<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title> 
    <link rel="stylesheet" href="/css/global.css">
    <link rel="stylesheet" href="/css/clientes.css">
    <link rel="stylesheet" href="/css/agendamentos.css">
    <link rel="stylesheet" href="/css/dashboard.css">
</head>
<body>
    <button class="menu-toggle" id="menuToggle">☰</button>
    <div class="dashboard-container">
        <aside class="sidebar" id="sidebar">
            <h2 id="sidebarCompanyName"></h2> 
            <nav>
                <ul>
                    <li><a href="/dashboard.html" class="active">Dashboard</a></li>
                    <li><a href="/clientes.html">Clientes</a></li>
                    <li><a href="/agendamentos.html">Agendamentos</a></li>
                    <li><a href="/livro-caixa.html">Livro Caixa</a></li>
                    <li><a href="/relatorios.html">Relatórios</a></li>
                    <li><a href="/profissionais.html">Gerenciar profissionais</a></li> 
                    <li><a href="/gerenciar-usuarios.html">Gerenciar Usuários</a></li>
                    <li style="margin-top: auto;"><a href="/api/auth/logout" style="color: #ffc107;">Sair</a></li> 
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <h1>Bem-vindo(a) ao Dashboard!</h1>
            </header>

            <section class="dashboard-cards">
                <div class="dashboard-card card-hoje">
                    <h3>Agendamentos de Hoje</h3>
                    <p class="count" id="agendamentosHojeCount">0</p>
                </div>
                <div class="dashboard-card card-semana">
                    <h3>Agendamentos da Semana</h3>
                    <p class="count" id="agendamentosSemanaCount">0</p>
                </div>
                <div class="dashboard-card card-confirmados">
                    <h3>Agendamentos Confirmados</h3>
                    <p class="count" id="agendamentosConfirmadosCount">0</p>
                </div>
                <div class="dashboard-card card-concluidos">
                    <h3>Agendamentos Concluídos</h3>
                    <p class="count" id="agendamentosConcluidosCount">0</p>
                </div>
            </section>

            <section class="recent-activity">
                <h2>Listagem dos Agendamentos do Dia</h2>
                <div id="agendamentosDoDiaList">
                    <p>Carregando agendamentos...</p>
                </div>
            </section>
        </main>
    </div>

    <script src="/js/main.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Lógica para carregar o nome da empresa dinamicamente ---
        const companyName = localStorage.getItem('companyName');
        const sidebarCompanyNameElement = document.getElementById('sidebarCompanyName');
        if (companyName) {
            document.title = `${companyName} - Dashboard`; // Atualiza o título da página
            if (sidebarCompanyNameElement) {
                sidebarCompanyNameElement.textContent = companyName;
            }
        } else {
            document.title = "Studio Je Marqui - Dashboard";
            if (sidebarCompanyNameElement) {
                sidebarCompanyNameElement.textContent = "Studio Je Marqui";
            }
        }
        // --- FIM DA LÓGICA DE NOME DA EMPRESA ---

        // --- Lógica do menu hambúrguer diretamente no dashboard.html ---
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');

        if (menuToggle && sidebar) {
            console.log("dashboard.html: Menu hambúrguer e sidebar encontrados. Adicionando listener.");
            menuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('active');
                console.log("dashboard.html: Menu hambúrguer clicado. Sidebar toggled.");
            });
        } else {
            console.warn("dashboard.html: Elementos do menu hambúrguer (menuToggle ou sidebar) não encontrados.");
        }
        // --- FIM DA LÓGICA DO MENU HAMBÚRGUER ---


        // --- Elementos para popular os dados dos cards ---
        const agendamentosHojeCountEl = document.getElementById('agendamentosHojeCount');
        const agendamentosSemanaCountEl = document.getElementById('agendamentosSemanaCount');
        const agendamentosConfirmadosCountEl = document.getElementById('agendamentosConfirmadosCount');
        const agendamentosConcluidosCountEl = document.getElementById('agendamentosConcluidosCount');
        const agendamentosDoDiaListEl = document.getElementById('agendamentosDoDiaList');


        // --- Função para buscar dados do Dashboard ---
        async function fetchDashboardData() {
            console.log("dashboard.html: Buscando dados do dashboard...");
            const token = localStorage.getItem('token');
            console.log("dashboard.html: Token lido do localStorage para requisicao:", token ? "Token presente" : "Token ausente");
            
            if (!token) {
                console.error("dashboard.html: Token não encontrado ao buscar dados do dashboard.");
                if (typeof logoutUser === 'function') {
                    logoutUser(); 
                } else {
                    console.error("Função logoutUser não encontrada. Redirecione manualmente.");
                    window.location.href = '/index.html';
                }
                return;
            }

            try {
                // Requisição para a rota /api/dashboard (que precisaremos ajustar no backend)
                const response = await fetch('/api/dashboard', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401 || response.status === 403) {
                    console.error("dashboard.html: Não autorizado ao buscar dados do dashboard. Redirecionando para login.");
                    if (typeof logoutUser === 'function') logoutUser();
                    return;
                }

                const data = await response.json();
                console.log("dashboard.html: Dados do dashboard recebidos:", data);

                // Popular os cards com os dados recebidos
                agendamentosHojeCountEl.textContent = data.agendamentosHojeCount || 0;
                agendamentosSemanaCountEl.textContent = data.agendamentosSemanaCount || 0;
                agendamentosConfirmadosCountEl.textContent = data.agendamentosConfirmadosCount || 0;
                agendamentosConcluidosCountEl.textContent = data.agendamentosConcluidosCount || 0;
                
                // --- Preenchimento da Listagem dos Agendamentos do Dia ---
                agendamentosDoDiaListEl.innerHTML = ''; // Limpa o conteúdo anterior
                if (Array.isArray(data.agendamentosDoDiaList) && data.agendamentosDoDiaList.length > 0) {
                    data.agendamentosDoDiaList.forEach(ag => {
                        const item = document.createElement('div');
                        item.className = 'activity-item'; // Você pode querer uma classe diferente aqui
                        const dataAgendamentoObj = new Date(ag.dataAgendamento);
                        const dataFormatada = dataAgendamentoObj.toLocaleDateString('pt-BR');
                        const horaFormatada = dataAgendamentoObj.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

                        item.innerHTML = `
                            <p><strong>${ag.cliente ? ag.cliente.nome : 'Cliente Removido'}</strong></p>
                            <p>${ag.procedimentos.map(p => p.nome).join(', ')}</p>
                            <p>Data: ${dataFormatada} às ${horaFormatada}</p>
                            <p>Status: ${ag.status}</p>
                            <hr>
                        `;
                        agendamentosDoDiaListEl.appendChild(item);
                    });
                } else {
                    agendamentosDoDiaListEl.innerHTML = '<p>Nenhum agendamento para hoje.</p>';
                }

            } catch (error) {
                console.error("dashboard.html: Erro ao buscar dados do dashboard:", error);
                // Define um estado de erro para os cards
                agendamentosHojeCountEl.textContent = 'Erro';
                agendamentosSemanaCountEl.textContent = 'Erro';
                agendamentosConfirmadosCountEl.textContent = 'Erro';
                agendamentosConcluidosCountEl.textContent = 'Erro';
                agendamentosDoDiaListEl.innerHTML = '<p style="color:red;">Erro ao carregar agendamentos.</p>';
            }
        }

        // Chama a função para buscar e popular os dados do dashboard
        fetchDashboardData();

        // --- Lógica do Temporizador de Inatividade (no final do DOMContentLoaded) ---
        const INACTIVITY_TIME = 10 * 60 * 1000; // 10 minutos em milissegundos
        let timeoutId;

        function startInactivityTimer() {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(logoutUser, INACTIVITY_TIME);
            console.log("dashboard.html: Timer de inatividade iniciado/reiniciado.");
        }

        window.resetInactivityTimer = function() { // Torna global para main.js ou outros scripts
            if (localStorage.getItem('token')) {
                startInactivityTimer();
            } else {
                console.log("dashboard.html: Não resetando timer: usuário não logado.");
            }
        }

        resetInactivityTimer(); // Inicia o temporizador quando a página carrega

        document.addEventListener('mousemove', resetInactivityTimer);
        document.addEventListener('keypress', resetInactivityTimer);
        document.addEventListener('click', resetInactivityTimer);
        document.addEventListener('scroll', resetInactivityTimer);
        // --- FIM DA LÓGICA DE INATIVIDADE ---
    });
    </script>
</body>
</html>