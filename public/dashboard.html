<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="/css/global.css">
    <link rel="stylesheet" href="/css/dashboard.css">
</head>
<body>
    <button class="menu-toggle" id="menuToggle">☰</button>
    <div class="dashboard-container">
        <aside class="sidebar" id="sidebar">
            <h2 id="sidebarCompanyName"></h2>
            <nav>
                <ul>
                    <li><a href="/dashboard.html" class="active">Dashboard</a></li>
                    <li><a href="/clientes.html">Clientes</a></li>
                    <li><a href="/agendamentos.html">Agendamentos</a></li>
                    <li><a href="/livro-caixa.html">Livro Caixa</a></li>
                    <li><a href="/relatorios.html">Relatórios</a></li>
                    <li><a href="/profissionais.html">Gerenciar Profissionais</a></li>
                    <li><a href="/gerenciar-usuarios.html">Gerenciar Usuários</a></li>
                    <li style="margin-top: auto;"><a href="/api/auth/logout" style="color: #ffc107;">Sair</a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <h1>Bem-vindo(a) ao seu Dashboard!</h1>
            </header>

            <section class="summary-cards">
                <div class="card">
                    <h3>Total de Clientes</h3>
                    <p id="totalClientes">0</p>
                </div>
                <div class="card">
                    <h3>Agendamentos Hoje</h3>
                    <p id="agendamentosHoje">0</p>
                </div>
                <div class="card">
                    <h3>Próximo Agendamento</h3>
                    <p id="proximoAgendamento">Nenhum</p>
                </div>
                <div class="card">
                    <h3>Receita do Mês</h3>
                    <p id="receitaMes">R$ 0,00</p>
                </div>
            </section>

            <section class="recent-activity">
                <h2>Atividade Recente</h2>
                <div id="recentActivityList">
                    <p>Carregando atividades...</p>
                </div>
            </section>
        </main>
    </div>

    <script src="/js/main.js"></script>
    <script>
    // --- INÍCIO DA LÓGICA DE INATIVIDADE ---
    const INACTIVITY_TIME = 10 * 60 * 1000; // 10 minutos em milissegundos
    let timeoutId;

    function startInactivityTimer() {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(logoutUser, INACTIVITY_TIME);
        console.log("dashboard.html: Timer de inatividade iniciado/reiniciado."); // DEBUG
    }

    function resetInactivityTimer() {
        if (localStorage.getItem('token')) {
            startInactivityTimer();
        } else {
            console.log("dashboard.html: Não resetando timer: usuário não logado."); // DEBUG
        }
    }
    // --- FIM DA LÓGICA DE INATIVIDADE ---

    document.addEventListener('DOMContentLoaded', () => {
        // --- Lógica para carregar o nome da empresa ---
        const companyName = localStorage.getItem('companyName');
        const sidebarCompanyNameElement = document.getElementById('sidebarCompanyName');

        if (companyName) {
            document.title = `${companyName} - Dashboard`;
            if (sidebarCompanyNameElement) {
                sidebarCompanyNameElement.textContent = companyName;
            }
        } else {
            document.title = "Studio Je Marqui - Dashboard";
            if (sidebarCompanyNameElement) {
                sidebarCompanyNameElement.textContent = "Studio Je Marqui";
            }
            // Se o nome da empresa não for encontrado, e não houver token,
            // o main.js já deve ter redirecionado.
            // Se houver token mas não companyName, pode ser um caso de erro,
            // mas o mais importante é o token.
        }
        // --- FIM DA MUDANÇA ---

        // --- Lógica do menu hambúrguer ---
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');

        if (menuToggle && sidebar) {
            console.log("dashboard.html: Menu hambúrguer e sidebar encontrados. Adicionando listener.");
            menuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('active');
                console.log("dashboard.html: Menu hambúrguer clicado. Sidebar toggled.");
            });
        } else {
            console.warn("dashboard.html: Elementos do menu hambúrguer (menuToggle ou sidebar) não encontrados.");
        }
        // --- FIM DA MUDANÇA ---

        const totalClientesEl = document.getElementById('totalClientes');
        const agendamentosHojeEl = document.getElementById('agendamentosHoje');
        const proximoAgendamentoEl = document.getElementById('proximoAgendamento');
        const receitaMesEl = document.getElementById('receitaMes');
        const recentActivityList = document.getElementById('recentActivityList');

        // Função para buscar dados do dashboard
        async function fetchDashboardData() {
            console.log("dashboard.html: Buscando dados do dashboard..."); // DEBUG
            const token = localStorage.getItem('token');
            if (!token) {
                console.error("dashboard.html: Token não encontrado ao buscar dados do dashboard."); // DEBUG
                logoutUser();
                return;
            }

            try {
                const response = await fetch('/api/dashboard', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401 || response.status === 403) {
                    console.error("dashboard.html: Não autorizado ao buscar dados do dashboard. Redirecionando para login."); // DEBUG
                    logoutUser();
                    return;
                }

                const data = await response.json();
                console.log("dashboard.html: Dados do dashboard recebidos:", data); // DEBUG

                totalClientesEl.textContent = data.totalClientes || 0;
                agendamentosHojeEl.textContent = data.agendamentosHoje || 0;
                receitaMesEl.textContent = formatAsCurrency(data.receitaMes || 0);

                if (data.proximoAgendamento) {
                    const ag = data.proximoAgendamento;
                    const dataAgendamentoObj = new Date(ag.dataAgendamento);
                    const dataFormatada = dataAgendamentoObj.toLocaleDateString('pt-BR');
                    const horaFormatada = dataAgendamentoObj.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    proximoAgendamentoEl.textContent = `${dataFormatada} às ${horaFormatada} - ${ag.cliente ? ag.cliente.nome : 'N/A'}`;
                } else {
                    proximoAgendamentoEl.textContent = 'Nenhum';
                }

                recentActivityList.innerHTML = '';
                if (Array.isArray(data.recentActivity) && data.recentActivity.length > 0) {
                    data.recentActivity.forEach(activity => {
                        const item = document.createElement('div');
                        item.className = 'activity-item';
                        // MUDANÇA AQUI: Formatação da data no fuso horário local
                        const activityDate = new Date(activity.timestamp).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                        item.innerHTML = `<p>${activity.description}</p><small>${activityDate}</small>`;
                        recentActivityList.appendChild(item);
                    });
                } else {
                    recentActivityList.innerHTML = '<p>Nenhuma atividade recente.</p>';
                }

            } catch (error) {
                console.error("dashboard.html: Erro ao buscar dados do dashboard:", error); // DEBUG
                // Não chama logoutUser aqui, pois pode ser um erro de rede temporário
                // ou outro problema que não exija deslogar o usuário.
                // A inatividade cuidará do logout se a sessão realmente expirar.
            }
        }

        // --- Inicialização e Event Listeners para o Timer de Inatividade ---
        resetInactivityTimer(); // Inicia o temporizador quando a página carrega

        document.addEventListener('mousemove', resetInactivityTimer);
        document.addEventListener('keypress', resetInactivityTimer);
        document.addEventListener('click', resetInactivityTimer);
        document.addEventListener('scroll', resetInactivityTimer);
        // --- FIM DA LÓGICA DE INATIVIDADE ---

        fetchDashboardData();
    });
    </script>
</body>
</html>